<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Gerenciar Usu√°rios</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; }
    .container { max-width: 800px; margin: 40px auto; padding: 20px; }
    h1 { margin-bottom: 20px; color: #333; }
    .info { background: #e8f5e9; border: 1px solid #4caf50; color: #2e7d32; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .error { background: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .success { background: #e8f5e9; border: 1px solid #4caf50; color: #2e7d32; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
    
    .form-group { margin: 20px 0; display: flex; flex-direction: column; }
    label { font-weight: bold; margin-bottom: 5px; }
    input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    button { padding: 10px 20px; background: #ff6a00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    button:hover { background: #e55a00; }
    button.secondary { background: #666; margin-left: 10px; }
    button.secondary:hover { background: #555; }
    button.delete { background: #f44336; }
    button.delete:hover { background: #d32f2f; }
    
    .users-list { background: white; padding: 20px; border-radius: 5px; }
    .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
    .user-info { flex: 1; }
    .user-role { font-size: 12px; color: #666; }
    .user-actions { display: flex; gap: 10px; }
    .user-actions button { padding: 5px 10px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gerenciar Usu√°rios - Invent√°rio 3F</h1>
    <p><a href="/">‚Üê Voltar</a></p>
    
    <div id="message"></div>
    
    <div style="background: white; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
      <h2 style="margin-bottom: 20px;">Adicionar/Editar Usu√°rio</h2>
      
      <div class="form-group">
        <label>Email do Usu√°rio:</label>
        <input type="email" id="username" placeholder="usuario@3f.local" required>
      </div>
      
      <div class="form-group">
        <label>Senha:</label>
        <input type="password" id="password" placeholder="Digite a senha">
        <small style="color: #666; margin-top: 5px;">* Deixe vazio se estiver editando e n√£o quer mudar a senha</small>
      </div>
      
      <div class="form-group">
        <label>Fun√ß√£o:</label>
        <select id="role">
          <option value="user">Usu√°rio</option>
          <option value="admin">Administrador</option>
        </select>
      </div>
      
      <div>
        <button onclick="salvarUsuario()">Salvar Usu√°rio</button>
        <button class="secondary" onclick="limparForm()">Limpar</button>
      </div>
    </div>
    
    <h2>Usu√°rios Cadastrados</h2>
    <div class="users-list" id="users-list">
      <p>Carregando...</p>
    </div>
  </div>

  <script>
    const API_BASE = '';

    async function carregarUsuarios() {
      try {
        console.log('Carregando usu√°rios...');
        const res = await fetch(`${API_BASE}/api/users`);
        console.log('Resposta:', res.status);
        
        if (!res.ok) {
          mostrarMensagem('Erro ao carregar usu√°rios: ' + res.status, 'error');
          return;
        }
        
        const usuarios = await res.json();
        console.log('Usu√°rios:', usuarios);
        
        const list = document.getElementById('users-list');
        if (!usuarios || usuarios.length === 0) {
          list.innerHTML = '<p>Nenhum usu√°rio cadastrado.</p>';
          return;
        }
        
        list.innerHTML = usuarios.map(u => `
          <div class="user-item">
            <div class="user-info">
              <strong>${u.username}</strong><br>
              <span class="user-role">Fun√ß√£o: ${u.role === 'admin' ? 'üë§ Administrador' : 'üë• Usu√°rio'}</span>
            </div>
            <div class="user-actions">
              <button onclick="editarUsuario('${u.username}')">Editar</button>
              ${u.username !== 'admin@3f.local' ? `<button class="delete" onclick="removerUsuario('${u.username}')">Remover</button>` : ''}
            </div>
          </div>
        `).join('');
      } catch (erro) {
        console.error('Erro:', erro);
        mostrarMensagem('Erro ao carregar: ' + erro.message, 'error');
      }
    }

    function editarUsuario(username) {
      document.getElementById('username').value = username;
      document.getElementById('username').disabled = true;
      document.getElementById('password').placeholder = 'Deixe vazio para n√£o mudar a senha';
    }

    function limparForm() {
      document.getElementById('username').value = '';
      document.getElementById('username').disabled = false;
      document.getElementById('password').value = '';
      document.getElementById('password').placeholder = 'Digite a senha';
      document.getElementById('role').value = 'user';
    }

    async function salvarUsuario() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;

      if (!username) {
        mostrarMensagem('Digite um email', 'error');
        return;
      }

      try {
        if (document.getElementById('username').disabled) {
          // Editando - mudar senha
          if (!password) {
            mostrarMensagem('Digite uma nova senha', 'error');
            return;
          }
          const res = await fetch(`${API_BASE}/api/users/change-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, newPassword: password })
          });
          
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Erro ao atualizar');
          }
          mostrarMensagem('‚úÖ Senha alterada com sucesso!', 'success');
        } else {
          // Criando novo
          if (!password) {
            mostrarMensagem('Digite uma senha', 'error');
            return;
          }
          const res = await fetch(`${API_BASE}/api/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, role })
          });
          
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error === 'exists' ? 'Usu√°rio j√° existe' : err.error || 'Erro ao criar');
          }
          mostrarMensagem('‚úÖ Usu√°rio criado com sucesso!', 'success');
        }
        
        limparForm();
        carregarUsuarios();
      } catch (erro) {
        mostrarMensagem('‚ùå ' + erro.message, 'error');
      }
    }

    async function removerUsuario(username) {
      if (!confirm(`Tem certeza que quer remover ${username}?`)) return;

      try {
        const res = await fetch(`${API_BASE}/api/users/${username}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Erro ao remover');
        mostrarMensagem('‚úÖ Usu√°rio removido!', 'success');
        carregarUsuarios();
      } catch (erro) {
        mostrarMensagem('‚ùå ' + erro.message, 'error');
      }
    }

    function mostrarMensagem(msg, tipo) {
      const div = document.getElementById('message');
      div.innerHTML = `<div class="${tipo}">${msg}</div>`;
      if (tipo === 'success') {
        setTimeout(() => { div.innerHTML = ''; }, 3000);
      }
    }

    // Carregar ao abrir
    console.log('P√°gina admin carregada');
    carregarUsuarios();
  </script>
      toast.textContent = msg;

</body>
</html>
